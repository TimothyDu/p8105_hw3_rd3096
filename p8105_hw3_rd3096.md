p8105_hw3_rd3096
================

# load necessary pakages

``` r
library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.4     ✔ readr     2.1.5
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.1
    ## ✔ ggplot2   3.5.1     ✔ tibble    3.2.1
    ## ✔ lubridate 1.9.3     ✔ tidyr     1.3.1
    ## ✔ purrr     1.0.2     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(ggridges)
library(patchwork)
library(ggplot2)

library(p8105.datasets)
data("ny_noaa")

knitr::opts_chunk$set(
    echo = TRUE,
    warning = FALSE,
    fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## problem 1

### read and explore the dataset “ny_noaa”

we explore the dataset and get a summary of the dataset

``` r
data("ny_noaa")
```

### we write a short description of the dataset and answer the following questions

Our dataset ahs 2595176 rows and 7 columns.It includes key variables
such as id (station identifier), date, prcp (precipitation), snow
(snowfall), snwd (snow depth), tmax (maximum temperature), and tmin
(minimum temperature).” The variable types based on our output are
listed as follows:

- id: character

- date: Date format

- prcp, snow, snwd: integer

- tmax, tmin: character (we wil convert these into numeric later for
  proper analysis).

Missing data is a significant issue in the ny_noaa dataset, especially
for snow depth (snwd) and snowfall (snow), Precipitation has less
missing data, but it still affects a non-negligible portion of the
dataset.

we will do some data cleaning for subquestion 1

``` r
ny_noaa_cleaned = 
  ny_noaa %>%
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>%
  mutate(
    tmax = as.numeric(tmax),    
    tmin = as.numeric(tmin)               
  )

ny_noaa_cleaned %>%
  group_by(snow) %>%
  summarize(count = n()) %>%
  arrange(desc(count))
```

    ## # A tibble: 282 × 2
    ##     snow   count
    ##    <int>   <int>
    ##  1     0 2008508
    ##  2    NA  381221
    ##  3    25   31022
    ##  4    13   23095
    ##  5    51   18274
    ##  6    76   10173
    ##  7     8    9962
    ##  8     5    9748
    ##  9    38    9197
    ## 10     3    8790
    ## # ℹ 272 more rows

After we cleaned our dataset, CONVERT the variables into numeric and
count the number of observed values, we found out:

1.  0 mm of snowfall is the most frequently observed value, with
    2,008,508 instances. This is because many days throughout the year
    do not experience snowfall, especially during non-winter months and
    in areas where snow is rare.

2.  There are 381,221 missing values (NA) in the dataset for snowfall.
    These might correspond to missing data for days or locations where
    snowfall was not recorded.

3.  Other common values include 25 mm, 13 mm, and 51 mm of snowfall,
    which likely represent light to moderate snowfall amounts. These
    values are typical during days when snow does occur, especially in
    regions that experience winter weather regularly.

we will make a two-panel plot for subquestion2

``` r
  ny_noaa_cleaned %>% 
  filter(month %in% c(1, 7)) %>% 
  group_by(id, year, month) %>% 
  summarize(avg_tmax = mean(tmax, na.rm = TRUE), .groups = 'drop') %>% 
  ggplot(aes(x = year, y = avg_tmax, color = id)) +
  geom_point()+
  geom_line()+
  facet_grid(. ~ month)+
  labs(
      title = "Mean Monthly Temperature for Each Station Across Years (January and July)",
    x = "Year",
    y = "Mean Max Temperature (°C)",
    color = "Station"
  ) +
theme(legend.position = "none")
```

<img src="p8105_hw3_rd3096_files/figure-gfm/unnamed-chunk-2-1.png" width="90%" />
The mean temperature in January is significantly lower than the mean
temperature in July across all stations and years. The stations show
consistent patterns of temperature fluctuations over time, with peaks
and valleys within each month. When one station exhibits a higher
monthly mean temperature in a given year, most other stations tend to
follow a similar pattern, indicating a general trend across regions.
However, there is an observable anomaly between 1980 and 1990, where one
station recorded an unusually cold temperature compared to others.

we will make a two-panel plot for subquestion3

``` r
tmax_tmin_p = 
  ny_noaa_cleaned %>%
  filter(!is.na(tmax), !is.na(tmin)) %>%  # Ensure there are no missing values
  ggplot(aes(x = tmin, y = tmax)) +
  geom_hex() +  # Use hexbin to show density of points
  scale_fill_viridis_c() +  # Use a continuous color scale
  labs(
    title = "tmax vs tmin",
    x = "Minimum Temperature (°C)",
    y = "Maximum Temperature (°C)",
    fill = "Density"
  ) +
  theme_minimal()


ny_noaa_ridge=
  ny_noaa_cleaned %>%
  filter(snow > 0 & snow < 100, !is.na(snow)) %>%  # Filter snowfall values
  ggplot(aes(x = snow, y = as.factor(year), fill = year)) +  # Treat year as a factor
  geom_density_ridges() +  # Create density ridges
  labs(
    title = "Snowfall Distribution by Year",
    x = "Snowfall (mm)",
    y = "Year"
  ) +
  theme_minimal()

tmax_tmin_p+ny_noaa_ridge
```

    ## Picking joint bandwidth of 3.76

<img src="p8105_hw3_rd3096_files/figure-gfm/unnamed-chunk-3-1.png" width="90%" />
\* The tmax vs tmin plot reveals a strong linear relationship between
maximum and minimum temperatures, but also highlights several extreme
outliers that need further investigation. These unrealistic values
likely reflect data quality issues.

- The snowfall distribution plot shows that snowfall values are fairly
  consistent across the years, with some variability, especially in the
  late 2000s where higher snowfall amounts are observed. However, no
  extreme deviations are evident in the snowfall distributions, and the
  overall pattern remains relatively stable over time.

## problem 2

### read the dataset

``` r
demo= read.csv("./demo.csv", na=c("NA","","."), skip=4) 
acce = read.csv("./acce.csv",na=c("NA","","."))
```

### load, tidy and merge the datasets

we will clean the dataset and recode sex and education as factor

``` r
demo_clean=
  demo %>% 
  filter(age>=21) %>% 
  mutate(
    sex=factor(
      case_match(
        sex,
        1~"Male",
        2~"Female"
      ),
      levels=c("Male", "Female")
    ),
    education = factor(
      case_match(
        education, 
        1 ~ "Less than high school",
        2 ~ "High school equivalent",
        3 ~ "More than high school",
      ),
      levels = c("Less than high school", "High school equivalent", "More than high school")  # Set as ordered factor because education has a natural order
    )
  ) %>% 
  drop_na(sex, age, BMI, education)
```

now we have ensured that any rows with missing values in sex, age, BMI,
or education are dropped after the necessary cleaning operations are
completed. And we have recoded sex and education as factor and define
the level of each variable.

we will merge the two dataset by SEQN

``` r
merged_data=
  left_join(demo_clean, acce, by = "SEQN")
```

produce a table for the number of men and women in each education
category, and create a visualization of the age distributions for men
and women in each education category

``` r
education_sex_table=
  demo_clean %>% 
  count(sex,education) %>% 
  arrange(education) %>% 
  select(education,everything()) %>% 
  knitr::kable()

education_sex_table
```

| education              | sex    |   n |
|:-----------------------|:-------|----:|
| Less than high school  | Male   |  27 |
| Less than high school  | Female |  28 |
| High school equivalent | Male   |  35 |
| High school equivalent | Female |  23 |
| More than high school  | Male   |  56 |
| More than high school  | Female |  59 |

``` r
age_sex_plot=
  demo_clean %>% 
  ggplot(aes(x=age,fill=sex))+
  geom_density(alpha=0.5)+
  facet_grid(.~ education)+
  labs(
    title = "Age Distributions for Men and Women by Education Level",
    x = "Age",
    y = "Density",
    fill = "Sex"
  ) +
  theme_minimal()

age_sex_plot
```

<img src="p8105_hw3_rd3096_files/figure-gfm/unnamed-chunk-7-1.png" width="90%" />
For our number of men and women in each education table:

- The table shows the number of men and women in each education
  category.

\*Less than high school: There are 27 males and 28 females, indicating a
nearly equal distribution between men and women.

\*High school equivalent: The count of men is higher (35) compared to
women (23), suggesting a higher representation of males in this
category.

\*More than high school: Females slightly outnumber males, with 59
females and 56 males. This shows a relatively balanced representation
but with a slight female dominance in the “more than high school” group.

Comment on the age distribution plot: \* Less than high school: Men and
women have similar age distributions, but men show a more distinct peak
around ages 50-60, while women have a smoother distribution.

- High school equivalent: Men and women have similar age distributions,
  with a slight difference in their peaks. Men show a more varied age
  distribution, and the distributions overlap more.

- More than high school: there is a prominent peak for women in the
  20–40 age range, indicating that a higher proportion of women in this
  category are concentrated in this younger age group. This peak is more
  pronounced than for men in the same category, who have a broader
  distribution over the age range, with a smaller peak in the same age
  group.

``` r
total_activity_new = 
  merged_data %>%
  pivot_longer(
    cols = starts_with("min"), # Select minute columns
    names_to = "minute", 
    values_to = "activity"
  ) %>%
  group_by(SEQN, sex, age, education) %>% # Group by SEQN and other demographic variables
  summarize(total_activity = sum(activity, na.rm = TRUE)) %>%
  ungroup() # Ungroup after summarizing
```

    ## `summarise()` has grouped output by 'SEQN', 'sex', 'age'. You can override
    ## using the `.groups` argument.

``` r
activity_age_plot=
  total_activity_new %>% 
  ggplot(aes(x=age, y=total_activity, color= sex)) +
  geom_point(alpha=0.5)+
  geom_smooth(se=FALSE)+
  facet_grid(.~ education)+
  labs(
    title = "Total Activity vs Age by Sex and Education Level",
    x = "Age",
    y = "Total Activity",
    color = "Sex"
  ) +
  theme_minimal() 
  
activity_age_plot
```

    ## `geom_smooth()` using method = 'loess' and formula = 'y ~ x'

<img src="p8105_hw3_rd3096_files/figure-gfm/unnamed-chunk-8-1.png" width="90%" />
Based on the three plots we created: In all education levels, women tend
to have slightly higher total activity levels compared to men,
especially in younger age ranges (20–40). However, this gap narrows as
participants age.Physical activity declines with age in both men and
women across all education levels.Higher education seems to be
associated with more stable activity levels over the lifespan,
particularly for women.Women tend to have higher total activity levels
compared to men in younger ages, but this difference diminishes in older
age.

``` r
merged_long=
  merged_data %>% 
  pivot_longer(
    cols=starts_with("min"),
    names_to = "minute", # Create a column called "minute"
    names_prefix = "min",
    values_to = "activity" 
  ) %>% 
  mutate(minute = as.numeric(minute))
  
activity_time_plot=
  merged_long %>% 
  ggplot(aes(x=minute,y=activity, color=sex)) +
  geom_smooth(se = FALSE) +   
  facet_grid(. ~ education) +    
  labs(
    title = "24-hour Activity Time Courses by Education Level and Sex",
    x = "Minute of the Day",
    y = "Activity (MIMS)"
  ) +
  theme_minimal() 

activity_time_plot
```

    ## `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'

<img src="p8105_hw3_rd3096_files/figure-gfm/unnamed-chunk-9-1.png" width="90%" />
The plot suggests that across all education levels, women tend to show
slightly higher overall activity compared to men, particularly during
peak activity hours. However, the differences are subtle, and the
overall daily activity pattern is quite similar across education levels.
This might indicate that education level does not dramatically affect
the general structure of activity throughout the day but could influence
the intensity of activity at peak times.

## problem 3

### import 4 csv datafiles

``` r
jan_2020 = 
  read_csv("./citibike/Jan 2020 Citi.csv") %>% 
  mutate(
    year=2020,
    month="january"
  ) %>% 
  select(year, month, everything())
```

    ## Rows: 12420 Columns: 7
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (6): ride_id, rideable_type, weekdays, start_station_name, end_station_n...
    ## dbl (1): duration
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
jan_2024 = 
  read_csv("./citibike/Jan 2024 Citi.csv") %>% 
  mutate(
    year=2024,
    month="january"
  ) %>% 
  select(year, month, everything())
```

    ## Rows: 18861 Columns: 7
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (6): ride_id, rideable_type, weekdays, start_station_name, end_station_n...
    ## dbl (1): duration
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
july_2020 = 
  read_csv("./citibike/July 2020 Citi.csv") %>% 
  mutate(
    year=2020,
    month="july"
  ) %>% 
  select(year, month, everything())
```

    ## Rows: 21048 Columns: 7
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (6): ride_id, rideable_type, weekdays, start_station_name, end_station_n...
    ## dbl (1): duration
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
july_2024 = 
  read_csv("./citibike/July 2024 Citi.csv") %>% 
  mutate(
    year=2024,
    month="july"
  ) %>% 
  select(year, month, everything())
```

    ## Rows: 47156 Columns: 7
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (6): ride_id, rideable_type, weekdays, start_station_name, end_station_n...
    ## dbl (1): duration
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
combined_bike=
  bind_rows(jan_2020, july_2020, jan_2024, july_2024)
```

we will create a reader-friendly table showing the total number of rides
in each combination of year and month separating casual riders and Citi
Bike members. Comment on these results.

``` r
ride_table=
  combined_bike %>% 
  group_by(year, month, member_casual) %>%
  summarise(total_ride = n()) %>%
  arrange(year, month, member_casual) %>% 
  knitr::kable()
```

    ## `summarise()` has grouped output by 'year', 'month'. You can override using the
    ## `.groups` argument.

``` r
ride_table
```

| year | month   | member_casual | total_ride |
|-----:|:--------|:--------------|-----------:|
| 2020 | january | casual        |        984 |
| 2020 | january | member        |      11436 |
| 2020 | july    | casual        |       5637 |
| 2020 | july    | member        |      15411 |
| 2024 | january | casual        |       2108 |
| 2024 | january | member        |      16753 |
| 2024 | july    | casual        |      10894 |
| 2024 | july    | member        |      36262 |

Based on the table we created:

1.  More Member Rides Than Casual Rides:In both years (2020 and 2024),
    there are consistently more rides from Citi Bike members compared to
    casual riders. This suggests that members make more frequent use of
    the system, likely due to lower costs and easier access through
    membership plans.

2.  Seasonal Variation:The number of rides, both casual and member,
    tends to increase in July compared to January. This trend is
    particularly strong for casual riders, as seen in 2020 and 2024.
    This makes sense as biking is more likely to be popular during
    warmer months.

3.  Increase in Member Usage Over Time:There is a sharp increase in
    member rides from January 2020 (11,436 rides) to July 2024 (36,262
    rides). This suggests that as the Citi Bike program has expanded, it
    has attracted more long-term users who become members.Overall, both
    casual and member rides have increased from 2020 to 2024. This
    likely reflects the growth of the Citi Bike system.

Next, we will make a table showing the 5 most popular starting stations
for July 2024; include the number of rides originating from these
stations.

``` r
july_2024_top_station=
  combined_bike %>%
  filter(year == 2024, month == "july") %>%
  group_by(start_station_name) %>%
  summarize(station_count = n()) %>%
  arrange(desc(station_count)) %>% 
  slice_head(n = 5) %>% 
  knitr::kable()

# Display the top 5 stations
july_2024_top_station
```

| start_station_name       | station_count |
|:-------------------------|--------------:|
| Pier 61 at Chelsea Piers |           163 |
| University Pl & E 14 St  |           155 |
| W 21 St & 6 Ave          |           152 |
| West St & Chambers St    |           150 |
| W 31 St & 7 Ave          |           146 |

we will make a plot to investigate the effects of day of the week,
month, and year on median ride duration

``` r
ride_duration_plot=
  combined_bike %>% 
  mutate(
    weekdays = 
      factor(weekdays, 
             levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")
             )
    ) %>% 
  group_by(year, month, weekdays) %>%
  summarize(median_duration = median(duration, na.rm = TRUE)) %>%
  ungroup() %>% 
  ggplot(aes(x = weekdays, y = median_duration, color = month)) +
  geom_point() +
  geom_line(aes(group = month)) + 
  facet_grid(. ~ year) + 
  labs(
    title = "Effects of Day of the Week, Month, and Year on Median Ride Duration",
    x = "Day of the Week",
    y = "Median Ride Duration (minutes)",
    color = "Month"
  ) +
  theme_minimal()
```

    ## `summarise()` has grouped output by 'year', 'month'. You can override using the
    ## `.groups` argument.

``` r
ride_duration_plot
```

<img src="p8105_hw3_rd3096_files/figure-gfm/unnamed-chunk-13-1.png" width="90%" /> 1.
July vs. January: July 2020 and 2024: In both years, the median ride
duration in July is consistently higher compared to January. This is
expected, as July likely represents warmer weather, which could
encourage longer rides. January: The median ride duration in January
remains more stable across the days of the week and is generally lower
than in July. This might be influenced by colder temperatures and less
favorable weather for biking. Day of the Week:

2.  Weekend Effect: In both July 2020 and July 2024, there is a notable
    increase in the median ride duration on Saturdays and Sundays,
    indicating that people may take longer rides during weekends,
    possibly for leisure. This pattern is less pronounced in January but
    still present, particularly on weekends in January 2024.

Weekdays: During weekdays, the median ride duration in July is
relatively consistent, though Fridays in July 2024 and Mondays in July
2020 see a slight rise.

3.  Year Comparison: 2020 vs. 2024: The ride durations seem slightly
    higher in 2024, particularly in July. This could suggest changes in
    user behavior or system expansion, although the effect varies
    somewhat by day of the week.

we make a figure that shows the impact of month, membership status, and
bike type on the distribution of ride duration

``` r
citi_2024_plot=
  combined_bike %>% 
  filter(year == 2024) %>% 
  ggplot(aes(x = duration, fill = member_casual)) +
  geom_density(alpha = 0.5) +  
  facet_grid(rideable_type ~ month) +  # Separate panels for bike type and month
  labs(
    title = "Impact of Month, Membership Status, and Bike Type on Ride Duration in 2024",
    x = "Ride Duration (minutes)",
    y = "Density",
    fill = "Membership Status"
  ) +
  theme_minimal()

citi_2024_plot
```

<img src="p8105_hw3_rd3096_files/figure-gfm/unnamed-chunk-14-1.png" width="90%" /> 1.
Impact of Membership Status: Casual riders (in purple) generally take
longer rides compared to members (in yellow), particularly for
shorter-duration rides. This is consistent across both bike types and
months.

2.  Comparison Between Months:

- In July, rides tend to be slightly shorter compared to January. This
  is visible across both casual riders and members, as the density peaks
  earlier in the July panels.

- The difference between casual and member rides is more noticeable in
  July, where casual riders have a larger proportion of rides lasting
  longer than those of members.

3.  Impact of Bike Type: The distribution patterns are similar for both
    classic and electric bikes. However, there is a slight indication
    that rides on electric bikes (bottom panels) tend to be shorter than
    rides on classic bikes (top panels), though the overall shape of the
    distribution remains similar.
